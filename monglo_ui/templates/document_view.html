{% extends "base.html" %}

{% block title %}{{ document._id }} - {{ collection.name }} - Monglo Admin{% endblock %}

{% block header_actions %}
<button class="monglo-btn monglo-btn-secondary" onclick="window.history.back()">
    <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" />
    </svg>
    Back to List
</button>
<button class="monglo-btn monglo-btn-primary" onclick="editMode()">
    <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
        <path
            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
    </svg>
    Edit
</button>
<button class="monglo-btn monglo-btn-danger" onclick="deleteDocument()">
    <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
            d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" />
    </svg>
    Delete
</button>
{% endblock %}

{% block content %}
<div class="monglo-document monglo-fade-in">
    <!-- Document Header -->
    <div
        style="margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--gray-200);">
        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: var(--spacing-sm);">
            {{ collection.display_name or collection.name }}
        </h1>
        <div style="display: flex; gap: var(--spacing-md); font-size: 0.875rem; color: var(--gray-600);">
            <span>
                <strong>ID:</strong>
                <code
                    style="background: var(--gray-100); padding: 0.125rem var(--spacing-sm); border-radius: var(--radius-sm);">
                    {{ document._id }}
                </code>
            </span>
            {% if document.created_at %}
            <span><strong>Created:</strong> {{ document.created_at|format_datetime }}</span>
            {% endif %}
            {% if document.updated_at %}
            <span><strong>Updated:</strong> {{ document.updated_at|format_datetime }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Document Tree View -->
    <div class="monglo-document-tree">
        {{ render_tree(document) }}
    </div>

    <!-- Relationships Section -->
    {% if relationships %}
    <div style="margin-top: var(--spacing-2xl); padding-top: var(--spacing-xl); border-top: 2px solid var(--gray-200);">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--spacing-lg); color: var(--gray-900);">
            Relationships
        </h2>
        <div
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--spacing-md);">
            {% for rel in relationships %}
            <div
                style="background: var(--gray-50); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid var(--gray-200);">
                <div
                    style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); margin-bottom: var(--spacing-sm);">
                    {{ rel.type }}
                </div>
                <a href="/admin/{{ rel.collection }}"
                    style="font-weight: 600; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: var(--spacing-sm);">
                    {{ rel.collection }}
                    <svg width="12" height="12" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" />
                    </svg>
                </a>
                <div style="margin-top: var(--spacing-sm); font-size: 0.875rem; color: var(--gray-600);">
                    {% if rel.count %}{{ rel.count }} related documents{% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

{% macro render_tree(obj, level=0) %}
<div class="monglo-tree-node" style=" margin-left: {{ level * 1.5 }}rem;">
    {% if obj is mapping %}
    <span style="color: var(--gray-400);">{</span>
    {% for key, value in obj.items() %}
    <div style="margin-left: var(--spacing-md);">
        <span class="monglo-tree-key">"{{ key }}"</span>:
        {% if value is mapping or value is iterable and value is not string %}
        {{ render_tree(value, level + 1) }}
        {% else %}
        <span class="monglo-tree-value {{ value|type_class }}">
            {% if value is string %}"{{ value }}"
            {% elif value is none %}null
            {% else %}{{ value }}{% endif %}
        </span>
        {% endif %}
        {% if not loop.last %},{% endif %}
    </div>
    {% endfor %}
    <span style="color: var(--gray-400);">}</span>
    {% elif obj is iterable and obj is not string %}
    <span style="color: var(--gray-400);">[</span>
    {% for item in obj %}
    <div style="margin-left: var(--spacing-md);">
        {{ render_tree(item, level + 1) }}{% if not loop.last %},{% endif %}
    </div>
    {% endfor %}
    <span style="color: var(--gray-400);">]</span>
    {% else %}
    <span class="monglo-tree-value {{ obj|type_class }}">
        {% if obj is string %}"{{ obj }}"
        {% elif obj is none %}null
        {% else %}{{ obj }}{% endif %}
    </span>
    {% endif %}
</div>
{% endmacro %}

<script>
    function editMode() {
        window.location.href = `/admin/{{ collection.name }}/edit/{{ document._id }}`;
    }

    function deleteDocument() {
        if (confirm('Are you sure you want to delete this document?')) {
            fetch(`/admin/{{ collection.name }}/{{ document._id }}`, { method: 'DELETE' })
                .then(() => window.location.href = `/admin/{{ collection.name }}`)
                .catch(err => alert('Error deleting document'));
        }
    }
</script>
{% endblock %}