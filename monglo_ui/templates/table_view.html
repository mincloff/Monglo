{% extends "base.html" %}

{% block title %}{{ collection.display_name or collection.name }} - Monglo Admin{% endblock %}

{% block header_actions %}
<button class="monglo-btn monglo-btn-primary" onclick="createDocument()">
    <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" />
    </svg>
    New {{ collection.display_name or collection.name }}
</button>
<button class="monglo-btn monglo-btn-secondary" onclick="exportData()">
    <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" />
    </svg>
    Export
</button>
{% endblock %}

{% block content %}
<!-- Toolbar -->
<div class="monglo-toolbar monglo-fade-in">
    <div class="monglo-search">
        <input type="text" class="monglo-input" placeholder="Search {{ collection.name }}..." id="search-input"
            onkeyup="handleSearch(event)">
    </div>

    <select class="monglo-input" style="min-width: 150px;" onchange="handleSort(event)">
        <option value="">Sort by...</option>
        {% for field in config.sortable_fields %}
        <option value="{{ field }}:asc">{{ field }} ↑</option>
        <option value="{{ field }}:desc">{{ field }} ↓</option>
        {% endfor %}
    </select>

    <select class="monglo-input" style="min-width: 120px;" onchange="handlePerPage(event)">
        <option value="20">20 per page</option>
        <option value="50">50 per page</option>
        <option value="100">100 per page</option>
    </select>
</div>

<!-- Table -->
<div class="monglo-table-container monglo-fade-in">
    <table class="monglo-table" id="data-table">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" onchange="toggleSelectAll(this)">
                </th>
                {% for column in config.columns %}
                <th onclick="sortBy('{{ column.field }}')">
                    {{ column.label }}
                    <span class="sort-indicator"></span>
                </th>
                {% endfor %}
                <th style="text-align: right;">Actions</th>
            </tr>
        </thead>
        <tbody id="table-body">
            {% for item in data.items %}
            <tr data-id="{{ item._id }}">
                <td>
                    <input type="checkbox" class="row-checkbox" value="{{ item._id }}">
                </td>
                {% for column in config.columns %}
                <td>
                    {% if column.formatter == 'datetime' %}
                    <span class="monglo-badge monglo-badge-info">
                        {{ item[column.field]|format_datetime }}
                    </span>
                    {% elif column.formatter == 'objectid' %}
                    <code style="font-size: 0.75rem; color: var(--gray-600);">
                            {{ item[column.field]|str|truncate(8) }}
                        </code>
                    {% elif column.formatter == 'boolean' %}
                    <span
                        class="monglo-badge {% if item[column.field] %}monglo-badge-success{% else %}monglo-badge-danger{% endif %}">
                        {{ item[column.field] }}
                    </span>
                    {% else %}
                    {{ item[column.field] }}
                    {% endif %}
                </td>
                {% endfor %}
                <td style="text-align: right;">
                    <div class="monglo-table-actions">
                        <button class="monglo-btn monglo-btn-secondary"
                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                            onclick="viewDocument('{{ item._id }}')">
                            View
                        </button>
                        <button class="monglo-btn monglo-btn-secondary"
                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                            onclick="editDocument('{{ item._id }}')">
                            Edit
                        </button>
                        <button class="monglo-btn monglo-btn-danger"
                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                            onclick="deleteDocument('{{ item._id }}')">
                            Delete
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="monglo-pagination monglo-fade-in">
    <div class="monglo-pagination-info">
        Showing {{ (data.page - 1) * data.per_page + 1 }} -
        {{ min(data.page * data.per_page, data.total) }}
        of {{ data.total }} results
    </div>

    <div class="monglo-pagination-buttons">
        {% if data.has_prev %}
        <button class="monglo-btn monglo-btn-secondary" onclick="goToPage({{ data.page - 1 }})">
            Previous
        </button>
        {% endif %}

        {% for page_num in range(max(1, data.page - 2), min(data.pages + 1, data.page + 3)) %}
        <button
            class="monglo-btn {% if page_num == data.page %}monglo-btn-primary{% else %}monglo-btn-secondary{% endif %}"
            onclick="goToPage({{ page_num }})">
            {{ page_num }}
        </button>
        {% endfor %}

        {% if data.has_next %}
        <button class="monglo-btn monglo-btn-secondary" onclick="goToPage({{ data.page + 1 }})">
            Next
        </button>
        {% endif %}
    </div>
</div>

<script>
    // Table View JavaScript
    const collection = '{{ collection.name }}';
    let currentPage = {{ data.page }};
    let currentSearch = '';
    let currentSort = '';
    let perPage = {{ data.per_page }};

    function handleSearch(event) {
        if (event.key === 'Enter') {
            currentSearch = event.target.value;
            reloadTable();
        }
    }

    function handleSort(event) {
        currentSort = event.target.value;
        reloadTable();
    }

    function handlePerPage(event) {
        perPage = parseInt(event.target.value);
        currentPage = 1;
        reloadTable();
    }

    function goToPage(page) {
        currentPage = page;
        reloadTable();
    }

    function reloadTable() {
        const params = new URLSearchParams({
            page: currentPage,
            per_page: perPage,
            search: currentSearch,
            sort: currentSort
        });

        window.location.href = `?${params.toString()}`;
    }

    function viewDocument(id) {
        window.location.href = `/admin/${collection}/document/${id}`;
    }

    function editDocument(id) {
        window.location.href = `/admin/${collection}/edit/${id}`;
    }

    function deleteDocument(id) {
        if (confirm('Are you sure you want to delete this document?')) {
            fetch(`/admin/${collection}/${id}`, { method: 'DELETE' })
                .then(() => reloadTable())
                .catch(err => alert('Error deleting document'));
        }
    }

    function createDocument() {
        window.location.href = `/admin/${collection}/new`;
    }

    function exportData() {
        window.location.href = `/admin/${collection}/export`;
    }

    function toggleSelectAll(checkbox) {
        document.querySelectorAll('.row-checkbox').forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }
</script>
{% endblock %}